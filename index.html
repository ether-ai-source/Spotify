<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seamless Spotify API Player</title>
    <style>
        :root {
            --spotify-green: #1DB954;
            --background-dark: #121212;
            --surface-light: #181818;
            --surface-medium: #282828;
            --text-light: #FFFFFF;
            --text-medium: #B3B3B3;
            --shadow: rgba(0, 0, 0, 0.7);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--background-dark);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .container {
            width: 100%;
            max-width: 400px;
            height: 90vh;
            max-height: 800px;
            background-color: var(--surface-light);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .login-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            height: 100%;
        }
        #login-button {
            background-color: var(--spotify-green);
            color: var(--text-light);
            border: none;
            padding: 16px 32px;
            border-radius: 500px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, filter 0.2s;
        }
        #login-button:hover { transform: scale(1.05); filter: brightness(1.1); }
        
        .player-view {
            display: none; /* Hidden by default */
            flex-direction: column;
            height: 100%;
        }
        .player-panel {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            text-align: center;
        }
        #artwork {
            width: 100%;
            max-width: 250px;
            aspect-ratio: 1 / 1;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px var(--shadow);
        }
        #title { font-size: 1.5em; font-weight: 600; margin-bottom: 5px; }
        #artist { font-size: 1em; color: var(--text-medium); margin-bottom: 20px; }
        .controls { display: flex; justify-content: center; align-items: center; gap: 30px; }
        .control-btn { background: none; border: none; color: var(--text-medium); font-size: 22px; cursor: pointer; transition: all 0.2s; }
        .control-btn:hover { color: var(--text-light); transform: scale(1.1); }
        .play-btn { font-size: 32px; color: var(--text-light); background-color: var(--spotify-green); width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        
        .playlist-panel {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 20px;
            border-top: 1px solid var(--surface-medium);
        }
        .playlist-panel h3 { padding: 20px 0 10px; position: sticky; top: 0; background: var(--surface-light); }
        .track-item {
            display: flex; align-items: center; margin-bottom: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s;
        }
        .track-item:hover { background-color: var(--surface-medium); }
        .track-item.playing { background-color: var(--spotify-green); }
        .track-item img { width: 40px; height: 40px; border-radius: 4px; margin-right: 12px; }
        .track-info h4 { font-size: 0.9em; font-weight: 500; }
        .track-info p { font-size: 0.8em; color: var(--text-medium); }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>

    <div class="container">
        <div class="login-view" id="login-view">
            <h1>Welcome</h1>
            <p>Connect your Spotify Premium account to begin.</p>
            <button id="login-button">Connect with Spotify</button>
        </div>

        <div class="player-view" id="player-view">
            <div class="player-panel">
                <img id="artwork" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" alt="Album Art">
                <h2 id="title">Select a song to play</h2>
                <p id="artist"></p>
                <div class="controls">
                    <button class="control-btn" id="prev-btn"><i class="fas fa-backward-step"></i></button>
                    <button class="control-btn play-btn" id="play-btn"><i class="fas fa-play"></i></button>
                    <button class="control-btn" id="next-btn"><i class="fas fa-forward-step"></i></button>
                </div>
            </div>
            <div class="playlist-panel">
                <h3>Your Top Tracks</h3>
                <div id="playlist-container"></div>
            </div>
        </div>
    </div>

    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // --- Configuration ---
        // PASTE YOUR CLIENT ID FROM THE SPOTIFY DEVELOPER DASHBOARD HERE
        const CLIENT_ID = "YOUR_CLIENT_ID_HERE"; 
        
        // This line automatically gets the correct URI.
        // Make sure this exact address is in your Spotify Dashboard settings.
        const REDIRECT_URI = window.location.href.split('#')[0]; 

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const playerView = document.getElementById('player-view');
        const loginButton = document.getElementById('login-button');
        const artworkEl = document.getElementById('artwork');
        const titleEl = document.getElementById('title');
        const artistEl = document.getElementById('artist');
        const playBtn = document.getElementById('play-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const playlistContainer = document.getElementById('playlist-container');

        let accessToken = null;
        let spotifyPlayer = null;
        let deviceId = null;

        // --- Main Logic ---
        window.onload = () => {
            accessToken = getAccessTokenFromUrl();
            if (accessToken) {
                // User has logged in, hide login and show player
                loginView.style.display = 'none';
                playerView.style.display = 'flex';
                initializeSpotifyPlayer();
            } else {
                // User needs to log in
                loginView.style.display = 'flex';
                playerView.style.display = 'none';
            }
        };

        loginButton.addEventListener('click', () => {
            const scopes = [
                'streaming',
                'user-read-email',
                'user-read-private',
                'user-modify-playback-state',
                'user-read-playback-state',
                'user-top-read'
            ].join(' ');
            const authUrl = `https://accounts.spotify.com/authorize?response_type=token&client_id=${CLIENT_ID}&scope=${encodeURIComponent(scopes)}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            window.location = authUrl;
        });

        function getAccessTokenFromUrl() {
            return new URLSearchParams(window.location.hash.substring(1)).get('access_token');
        }

        function initializeSpotifyPlayer() {
            window.onSpotifyWebPlaybackSDKReady = () => {
                spotifyPlayer = new Spotify.Player({
                    name: 'Seamless Web Player',
                    getOAuthToken: cb => { cb(accessToken); },
                    volume: 0.5
                });

                spotifyPlayer.addListener('ready', async ({ device_id }) => {
                    console.log('Player is ready with Device ID', device_id);
                    deviceId = device_id;
                    const topTracks = await getUsersTopTracks();
                    renderPlaylist(topTracks);
                });

                spotifyPlayer.addListener('player_state_changed', updateUI);
                spotifyPlayer.addListener('account_error', () => { alert('You must have a Spotify Premium account to use this player.'); });
                spotifyPlayer.connect();
            };
        }

        // --- API Interaction ---
        async function fetchWebApi(endpoint, method = 'GET', body = null) {
            const res = await fetch(`https://api.spotify.com/${endpoint}`, {
                headers: { Authorization: `Bearer ${accessToken}` },
                method,
                body: body ? JSON.stringify(body) : null
            });
            if (res.status === 204 || res.status > 299) return null;
            return await res.json();
        }

        async function getUsersTopTracks() {
            const response = await fetchWebApi('v1/me/top/tracks?time_range=medium_term&limit=20');
            return response?.items || [];
        }

        async function playTrack(trackUri) {
            if (!deviceId) return;
            await fetchWebApi(`v1/me/player/play?device_id=${deviceId}`, 'PUT', { uris: [trackUri] });
        }

        // --- UI Updates ---
        function renderPlaylist(tracks) {
            playlistContainer.innerHTML = '';
            tracks.forEach(track => {
                const trackItem = document.createElement('div');
                trackItem.className = 'track-item';
                trackItem.dataset.uri = track.uri;
                trackItem.innerHTML = `
                    <img src="${track.album.images[2]?.url}" alt="${track.album.name}">
                    <div class="track-info">
                        <h4>${track.name}</h4>
                        <p>${track.artists.map(a => a.name).join(', ')}</p>
                    </div>
                `;
                trackItem.addEventListener('click', () => playTrack(track.uri));
                playlistContainer.appendChild(trackItem);
            });
        }

        function updateUI(state) {
            if (!state) return;
            const track = state.track_window.current_track;
            artworkEl.src = track.album.images[0].url;
            titleEl.textContent = track.name;
            artistEl.textContent = track.artists.map(a => a.name).join(', ');
            playBtn.querySelector('i').className = state.paused ? 'fas fa-play' : 'fas fa-pause';

            document.querySelectorAll('.track-item').forEach(item => {
                item.classList.toggle('playing', item.dataset.uri === track.uri);
            });
        }

        playBtn.addEventListener('click', () => spotifyPlayer?.togglePlay());
        prevBtn.addEventListener('click', () => spotifyPlayer?.previousTrack());
        nextBtn.addEventListener('click', () => spotifyPlayer?.nextTrack());
    </script>
</body>
</html>
